name: Check Download Links

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'bin/ltbox/config.json'
      - 'bin/ltbox/downloader.py'
      - '.github/workflows/link_check.yml'

jobs:
  check-urls:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run URL Check Script
        run: |
          cat <<EOF > check_links.py
          import json
          import sys
          import requests
          import re
          from pathlib import Path

          def check_url(url, description):
              print(f"Checking {description}...", end=" ")
              try:
                  response = requests.get(url, stream=True, timeout=15)
                  if response.status_code in [200, 302]:
                      print(f"OK ({url})")
                      return True
                  else:
                      print(f"FAILED (Status: {response.status_code}) - {url}")
                      return False
              except Exception as e:
                  print(f"ERROR - {url} ({e})")
                  return False

          def check_github_api(owner_repo, tag, description):
              if "github.com/" in owner_repo:
                  owner_repo = owner_repo.split("github.com/")[-1]

              if not tag or tag == "latest":
                  url = f"https://api.github.com/repos/{owner_repo}/releases/latest"
              else:
                  url = f"https://api.github.com/repos/{owner_repo}/releases/tags/{tag}"

              return check_url(url, f"GitHub API ({description})")

          def main():
              config_path = Path('bin/ltbox/config.json')
              if not config_path.exists():
                  print("::error::Config file not found!")
                  sys.exit(1)

              with open(config_path, 'r', encoding='utf-8') as f:
                  config = json.load(f)

              has_error = False

              # 1. Static Tools
              tools = config.get('tools', {})
              print("--- Static Tools ---")
              if not check_url(tools.get('platform_tools_url'), "Platform Tools"): has_error = True
              if not check_url(tools.get('avb_archive_url'), "AVB Archive"): has_error = True
              if not check_url(tools.get('openssl_url'), "OpenSSL"): has_error = True

              # 2. Magiskboot (GitHub Release)
              print("\n--- Magiskboot ---")
              mb = config.get('magiskboot', {})
              if not check_github_api(mb.get('repo_url'), mb.get('tag'), "Magiskboot Release"): has_error = True

              # 3. KernelSU-Next (GitHub Release)
              print("\n--- KernelSU-Next ---")
              ksu = config.get('kernelsu-next', {})
              ksu_repo = ksu.get('repo') or ksu.get('apk_repo')
              ksu_tag = ksu.get('tag') or ksu.get('apk_tag')

              # 3-1. Release API Check
              if not check_github_api(ksu_repo, ksu_tag, "KernelSU-Next Release"): has_error = True

              # 3-2. KSUInit (Raw)
              ksuinit_url = f"https://github.com/{ksu_repo}/raw/refs/tags/{ksu_tag}/userspace/ksud/bin/aarch64/ksuinit"
              if not check_url(ksuinit_url, "KSUInit Binary"): has_error = True

              # 3-3. KernelSU Next (Nightly)
              nightly_wf = ksu.get('nightly_workflow')
              nightly_mgr = ksu.get('nightly_manager')
              if nightly_wf and nightly_mgr:
                   url = f"https://nightly.link/{ksu_repo}/actions/runs/{nightly_wf}/{nightly_mgr}"
                   if not check_url(url, "KernelSU-Next Nightly"): has_error = True

              # 4. GKI_KernelSU_SUSFS
              print("\n--- WildKernels ---")
              wk = config.get('wildkernels', {})
              wk_owner = wk.get('owner', 'WildKernels')
              wk_repo = wk.get('repo', 'GKI_KernelSU_SUSFS')
              wk_tag = wk.get('tag', 'latest')
              if not check_github_api(f"{wk_owner}/{wk_repo}", wk_tag, "WildKernels GKI"): has_error = True

              # 5. SukiSU Ultra (Nightly)
              print("\n--- SukiSU Ultra ---")
              suki = config.get('sukisu-ultra', {})
              suki_repo = suki.get('repo')
              suki_wf = suki.get('workflow')
              suki_mgr = suki.get('manager')
              if suki_repo and suki_wf and suki_mgr:
                  url = f"https://nightly.link/{suki_repo}/actions/runs/{suki_wf}/{suki_mgr}"
                  if not check_url(url, "SukiSU Nightly"): has_error = True

              if has_error:
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

          python check_links.py
